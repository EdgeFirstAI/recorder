# GitHub Actions workflow for publishing releases
#
# This workflow publishes release artifacts when a version tag is pushed.
# It does NOT rebuild artifacts — instead it waits for the build.yml and
# sbom.yml workflows (triggered by the same commit on main) to complete,
# then downloads their artifacts for the GitHub Release.
#
# Release Process:
# 1. Update version in Cargo.toml and CHANGELOG.md
# 2. Commit and push to main
# 3. Tag: git tag -a -s -m "Version X.Y.Z" vX.Y.Z && git push origin vX.Y.Z
#
# Action Versions (hash-pinned per SPS v2.1):
# - actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 (v4)
# - lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc (v1.3.4)
# - dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11 (v6)
# - softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b (v2)

name: Release

on:
  push:
    tags: ['v*']

jobs:
  # ==========================================================================
  # Prepare Release Information
  # ==========================================================================
  prepare-release:
    name: Prepare Release Information
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          CHANGELOG=$(awk -v ver="$VERSION" '
            /^## \['"$VERSION"'\]/ { found=1; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          if [ -z "$CHANGELOG" ]; then
            echo "ERROR: No changelog entry found for version $VERSION"
            exit 1
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Extracted changelog:"
          echo "$CHANGELOG"

  # ==========================================================================
  # Wait for CI Workflows to Complete
  # ==========================================================================
  wait-for-ci:
    name: Wait for CI Workflows
    needs: [prepare-release]
    runs-on: ubuntu-22.04
    steps:
      - name: Wait for Build workflow
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc  # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Verify Builds'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Wait for SBOM workflow
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc  # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Generate SBOM & Check License Compliance'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  # ==========================================================================
  # Create GitHub Release with pre-built artifacts
  # ==========================================================================
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs:
      - prepare-release
      - wait-for-ci
    permissions:
      contents: write
      actions: read

    steps:
      - name: Download x86_64 package
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11  # v6
        with:
          workflow: build.yml
          commit: ${{ github.sha }}
          name: packages-x86_64
          path: artifacts/packages-x86_64

      - name: Download aarch64 package
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11  # v6
        with:
          workflow: build.yml
          commit: ${{ github.sha }}
          name: packages-aarch64
          path: artifacts/packages-aarch64

      - name: Download SBOM
        uses: dawidd6/action-download-artifact@bf251b5aa9c2f7eeb574a96ee720e24f801b7c11  # v6
        with:
          workflow: sbom.yml
          commit: ${{ github.sha }}
          name: sbom
          path: artifacts/sbom

      - name: Organize release assets
        env:
          VERSION: ${{ needs.prepare-release.outputs.version }}
        run: |
          mkdir -p release-assets

          # Copy x86_64 binary
          if [ -f artifacts/packages-x86_64/edgefirst-recorder-x86_64 ]; then
            cp artifacts/packages-x86_64/edgefirst-recorder-x86_64 \
               "release-assets/edgefirst-recorder-v${VERSION}-linux-x86_64"
            echo "✓ x86_64 binary"
          else
            echo "ERROR: x86_64 binary not found"
            exit 1
          fi

          # Copy ARM64 binary
          if [ -f artifacts/packages-aarch64/edgefirst-recorder-aarch64 ]; then
            cp artifacts/packages-aarch64/edgefirst-recorder-aarch64 \
               "release-assets/edgefirst-recorder-v${VERSION}-linux-aarch64"
            echo "✓ aarch64 binary"
          else
            echo "ERROR: aarch64 binary not found"
            exit 1
          fi

          # Copy SBOM
          if [ -f artifacts/sbom/sbom.json ]; then
            cp artifacts/sbom/sbom.json \
               "release-assets/edgefirst-recorder-v${VERSION}-sbom.json"
            echo "✓ SBOM"
          else
            echo "ERROR: SBOM not found"
            exit 1
          fi

          echo ""
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2
        with:
          name: EdgeFirst Recorder v${{ needs.prepare-release.outputs.version }}
          body: |
            # EdgeFirst Recorder v${{ needs.prepare-release.outputs.version }}

            ## Downloads

            - **Linux x86_64**: `edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-linux-x86_64`
            - **Linux ARM64**: `edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-linux-aarch64`
            - **SBOM**: `edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-sbom.json`

            ## Installation

            ```bash
            # Download binary (replace URL with your platform)
            wget https://github.com/EdgeFirstAI/recorder/releases/download/v${{ needs.prepare-release.outputs.version }}/edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-linux-aarch64

            # Make executable
            chmod +x edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-linux-aarch64

            # Run
            ./edgefirst-recorder-v${{ needs.prepare-release.outputs.version }}-linux-aarch64 --help
            ```

            ## What's Changed

            ${{ needs.prepare-release.outputs.changelog }}

            ---

            **Full Documentation**: https://github.com/EdgeFirstAI/recorder#readme
          files: |
            release-assets/*
          draft: false
          prerelease: ${{ contains(needs.prepare-release.outputs.version, '-') }}
          fail_on_unmatched_files: true
